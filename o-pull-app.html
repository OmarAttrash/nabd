<link rel="import" href="bower_components/iron-pages/iron-pages.html">
<link rel="import" href="components/o-parse/o-parse-connect.html"></script>
<link rel="import" href="components/o-parse/o-parse-login-button.html"></script>
<link rel="import" href="components/o-parse/o-parse-pulls.html"></script>
<link rel="import" href="bower_components/iron-list/iron-list.html">
<link rel="import" href="bower_components/polymer/polymer.html">

<dom-module id="o-pull-app">
	<template>
	<style>
		iframe{
			left:0;
		}
	</style>
		<o-parse-connect></o-parse-connect>
		<iron-pages id="pages" selected="{{page}}">
			<div><o-parse-login-button logged="{{userStatus}}" id="login"></o-parse-login-button></div>
			<div><o-parse-pulls id="pulls"></o-parse-pulls></div>
			<div>
				<h1>{{selectedPullObject.attributes.question}}</h1>	
				<ul id="votes">
					<iron-list items="[[selectedPullObject.attributes.answers]]" as="answer" index-as="index">
						<template>
							<li><input type="checkbox" value="[[index]]" on-click="vote" checked="[[answer.checked]]"/><span>[[answer.answer]]</span>  votes:<span>[[answer.votes]]</span></li>
						</template>
					</iron-list>	
				</ul>				
				<div id="comments"></div>
			</div>
		</iron-pages>
	</template>
	<script>
		Polymer({
			is:"o-pull-app",
			properties:{
				commentsLoaded:false,
				page:{
					type:Number,
					value:0,
					observer: 'pageChanged'
				}
			},
			ready:function(){
				this.loging();
				var root = this;
				this.$.login.addEventListener('logged',function(){
					root.loging();
				});
				
				window.addEventListener("hashchange",function(){
					if(window.location.hash) {
						root.selectedPull = window.location.hash.substring(1);
						root.page = 2;
					} 
					else{
						root.page = 1;
					}
				});
			},
			loging : function(){
				if(this.userStatus === true){
					this.page = 1;
					if(window.location.hash) {
						this.selectedPull = window.location.hash.substring(1);
						this.page = 2;
					} 
				}
			},
			calculateUrl: function(s){
				console.log(s);
				return "https://omarattrash.github.io/nabd/#" + s ;
				//return "https://omarattrash.github.io/nabd/?pull=" + s ;
			},
			pageChanged:function(newVal,oldVal){
				if(newVal == 1){
					if(Parse.User.current() != null){
						this.$.pulls.loadPulls();
					}
				}
				if(newVal == 2){
					var root = this;
					var Pull = Parse.Object.extend("Pull");
					var query = new Parse.Query(Pull);
					Parse.Cloud.run("getAnswers", {pullId:this.selectedPull}, {
						success: function(results) {
							console.dir(results);
							root.selectedPullObject = results;
							console.dir(root.selectedPullObject);
							root.$.comments.innerHTML = '<div class="fb-comments" data-href="'+root.calculateUrl(root.selectedPull)+'" data-numposts="5"></div>';	
							FB.XFBML.parse();
						}
					});
					
				}
			},
			vote : function(){
				var root =this;
				var checkboxes = Polymer.dom(this.$.votes).querySelectorAll('li input[type=checkbox]');
				var answsersArray = [];
				console.dir(checkboxes);
				for(var i=0;i<checkboxes.length;i++){
					console.log(checkboxes[i].checked);
					console.dir(checkboxes[i]);
					if(checkboxes[i].checked){
						answsersArray.push(parseInt(checkboxes[i].value));
					}
					
				}
			
				var req = {answers:answsersArray,pullId:root.selectedPullObject.id};
				console.dir(req);
				Parse.Cloud.run("vote", req, {
									  success: function(result) {
										console.dir(result);
									  },
									  error: function(error) {
										console.dir(error);
									  }
				});
			}
		});
	</script>
</dom-module>